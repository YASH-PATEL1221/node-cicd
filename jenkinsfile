pipeline{
    agent any

    tools{
        nodejs "nodejs"
    }

    environment{
        APP_NAME="yashpatel274/temp-node"
        BUILD_NUMBER=currentBuild.number
    }

    stages{
        stage('git checkout') {
            steps{
                git credentialsId: 'github-ssh', url: 'git@github.com:YASH-PATEL1221/node-cicd.git'
            }
        }

        stage('install dependency'){
            steps{
                sh 'npm install'
            }
        }

        stage('docker build'){
            steps{
                    script{
                        withDockerRegistry(credentialsId: 'docker-login', toolName: 'docker') {
                            sh "docker build -t $APP_NAME:${env.BUILD_NUMBER} ."
                        }
                    }
            }
        }
    
        stage('Scan Docker Image'){
            steps{
                script{
                    def trivyOutput = sh(script: "trivy image $APP_NAME:latest", returnStdout: true).trim()

                    println trivyOutput

                    if (trivyOutput.contains("Total: 0")) {
                        echo "No vulnerabilities found in the Docker image."
                    } else {
                        echo "Vulnerabilities found in the Docker image."
                        return;
                    }
                }
            }
        }

        stage("Push to docker hub"){
            steps{
                script{
                    sh "docker push yashpatel274/temp-node:${env.BUILD_NUMBER}"
                }
            }
        }

    }
}